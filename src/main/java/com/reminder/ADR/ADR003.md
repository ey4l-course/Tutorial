# ADR003: Use `userId` from SecurityContext Instead of Redundant DB Query

**Status**: Accepted  
**Date**: 2025-08-01

## Context

The `CustomUserDetails` class, which is stored in the `SecurityContext` during authentication, includes the `userId` field alongside the `userName` and `role`. Despite this, the code in some services redundantly queried the database using `userName` just to retrieve the user ID.

This issue became evident while implementing authenticated self-service operations (e.g., updating user profile), which rely on `userId` to match foreign keys in other tables like `user_crm`.

## Decision

We refactored the controller logic to extract the `userId` directly from the `SecurityContext`, avoiding unnecessary DB lookups.

Example:
```java
Long userId = ((CustomUserDetails) SecurityContextHolder.getContext()
        .getAuthentication().getPrincipal()).getUserId();
```
This leverages the information already present in the authenticated session.

Consequences
------------

* ✅ Avoids redundant queries to fetch user ID
* ✅ Reduces coupling between layers (controller and DB)
* ⚠ Requires explicit casting to `CustomUserDetails`
* ⚠ Tightens coupling to the current security implementation (acceptable for now)