### ADR003: Merging Partial Profile Updates Before Persisting

**Status**: Accepted  
**Date**: 2025-08-03  
**Context**:  
The `UserUpdateDTO` used in the self-service profile update may contain only a subset of fields (e.g., only email or mobile). If null fields are blindly persisted, they may overwrite existing data in the database with `NULL`. Additionally, the `serviceLevel` calculation logic relies on both fields being present to determine the correct level (1–3).

**Decision**:  
When updating the user's profile:
- Retrieve the existing profile from the database using the user's ID.
- For each field in `UserUpdateDTO`, if it is `null` or empty, replace it with the corresponding value from the existing profile.
- This merged DTO is then used to:
    - Recalculate the `serviceLevel` correctly.
    - Pass to the repository for update.

This approach ensures:
- No accidental overwrites of missing fields.
- Accurate service level determination based on a complete data set.

**Implementation Summary**:
```java
public void updateMyProfile(Long userId, UserUpdateDTO detailsDTO) {
    validateUpdateDetails(detailsDTO);
    detailsDTO = mergeProfiles(detailsDTO, userId);
    detailsDTO.setServiceLevel(determineServiceLevel(detailsDTO.getEmail(), detailsDTO.getMobile()));
    usersRepository.updateMyProfile(userId, detailsDTO);
}

private UserUpdateDTO mergeProfiles(UserUpdateDTO newProfile, long id){
    UserCrm existingProfile = usersRepository.getUserProfileById(id);
    if (newProfile.getEmail() == null || newProfile.getEmail().isEmpty())
        newProfile.setEmail(existingProfile.getEmail());
    if (newProfile.getMobile() == null || newProfile.getMobile().isEmpty())
        newProfile.setMobile(existingProfile.getMobile());
    return newProfile;
}
```
Consequences:
-
* Adds a DB query per profile update to fetch existing values.
* Ensures that updates are safe and partial inputs don’t cause unintended data loss.
* Improves accuracy of logic that depends on multiple fields (like service level).